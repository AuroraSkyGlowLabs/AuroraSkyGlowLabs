<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AuroraSkyGlowLabs ‚Äì Aurora Reports (Beta)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin:0; font-family:system-ui, sans-serif; background:#0b1020; color:#eaeaf0; }
    header { padding:12px 16px; background:#121a36; border-bottom:1px solid #243066; display:flex; flex-direction:column; gap:8px; }
    .top-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    h1 { margin:0; font-size:1.2rem; }
    #map { height:60vh; width:100%; }
    form { margin:12px 16px; background:#121a36; padding:10px; border-radius:6px; max-width:560px; }
    input, button { margin:4px 0; padding:8px; border-radius:4px; border:1px solid #243066; width:100%; box-sizing:border-box; background:#0b1020; color:#eaeaf0; }
    button { background:#243066; font-weight:bold; cursor:pointer; }
    #legend { position:absolute; top:86px; right:12px; background:rgba(18,26,54,0.95); color:#eaeaf0; padding:8px; border-radius:6px; border:1px solid #243066; font-size:0.9rem; z-index:1000; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:rgba(36,48,102,0.95); color:#fff; padding:8px 12px; border-radius:6px; z-index:2000; display:none; font-size:0.95rem; }
    .visible { display:block; }
  </style>
</head>
<body>

<header>
  <div class="top-row">
    <h1>üåå AuroraSkyGlowLabs ‚Äî Aurora Reports (BETA)</h1>
    <div>
      <button id="locate-btn">üìç Use my location</button>
      <span id="location-status"></span>
    </div>
  </div>
  <div>Reports are community-submitted. Locations are blurred for privacy.</div>
</header>

<div id="map" aria-label="Aurora reports map"></div>
<div id="legend">
  <strong>Legend</strong>
  <div style="margin-top:6px;">
    <div><span style="display:inline-block;width:12px;height:12px;background:#39ff14;"></span> Aurora</div>
    <div><span style="display:inline-block;width:12px;height:12px;background:#ffcc00;"></span> Meteor / Fireball</div>
    <div><span style="display:inline-block;width:12px;height:12px;background:#ffffff;border:1px solid #ccc;"></span> Full Moon / Lunar</div>
    <div><span style="display:inline-block;width:12px;height:12px;background:#66a3ff;"></span> Other</div>
  </div>
</div>

<form id="report-form">
  <h3>Submit a Report</h3>
  <input type="text" id="event" placeholder="Aurora, Meteor Shower..." required />
  <input type="number" step="0.01" id="lat" placeholder="Latitude" required />
  <input type="number" step="0.01" id="lng" placeholder="Longitude" required />
  <button type="submit">Submit Report</button>
</form>

<div id="toast" class="toast"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const SUPABASE_URL = 'https://coabskvhjoomkpwbpogk.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvYWJza3Zoam9vbWtwd2Jwb2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MTE4NjQsImV4cCI6MjA4MzQ4Nzg2NH0.NEoNDNyRFHhIl4zYbaTR1HEWP8UpeHdd4shiWW5qZP0';
  const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const map = L.map('map').setView([43,-88],4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap contributors' }).addTo(map);
  L.control.scale().addTo(map);

  const ANON_PRECISION = 1;
  const EVENT_COLORS = { aurora:'#39ff14', meteor:'#ffcc00', moon:'#ffffff', default:'#66a3ff' };

  function anonymizeCoord(v){ return Math.round(v*Math.pow(10,ANON_PRECISION))/Math.pow(10,ANON_PRECISION); }
  function showToast(msg,d=3000){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('visible'); setTimeout(()=>t.classList.remove('visible'),d); }

  function getEventColor(name=''){ const n=name.toLowerCase(); if(n.includes('aurora'))return EVENT_COLORS.aurora; if(n.includes('meteor'))return EVENT_COLORS.meteor; if(n.includes('moon'))return EVENT_COLORS.moon; return EVENT_COLORS.default; }

  let userMarker=null;
  const locationStatus=document.getElementById('location-status');

  function handleGeoSuccess(pos){
    const lat=anonymizeCoord(pos.coords.latitude);
    const lng=anonymizeCoord(pos.coords.longitude);
    if(userMarker){ userMarker.setLatLng([lat,lng]); }
    else{ userMarker=L.circleMarker([lat,lng],{radius:8,fillColor:'#ff66b2',color:'#fff',weight:1,fillOpacity:0.9}).addTo(map).bindPopup('You (approx)'); }
    map.setView([lat,lng],6);
    document.getElementById('lat').value=lat;
    document.getElementById('lng').value=lng;
    locationStatus.textContent='Location set (blurred)';
    showToast('Location detected and anonymized.');
  }
  function handleGeoError(){ locationStatus.textContent='Location unavailable'; showToast('Unable to get location.'); }
  document.getElementById('locate-btn').addEventListener('click',()=>{ if(navigator.geolocation) navigator.geolocation.getCurrentPosition(handleGeoSuccess,handleGeoError); });

  // Load Supabase reports
  const markers=[];
  async function loadReports(){
    const { data,error } = await supabase.from('Aurora_reportss').select('*');
    if(error){ console.error(error); showToast('Failed to load reports.'); return; }
    data.forEach(r=>{ const lat=anonymizeCoord(r.lat); const lng=anonymizeCoord(r.lng); const color=getEventColor(r.event); L.circleMarker([lat,lng],{radius:7,fillColor:color,color:'#000',weight:1,opacity:0.9,fillOpacity:0.9}).addTo(map).bindPopup(`<strong>Event:</strong> ${r.event}`); });
  }
  loadReports();

  // Real-time subscription
  supabase.channel('public:aurora_reportss').on('postgres_changes',{event:'INSERT',schema:'public',table:'Aurora_reportss'},payload=>{
    const r=payload.new; const lat=anonymizeCoord(r.lat); const lng=anonymizeCoord(r.lng); const color=getEventColor(r.event);
    L.circleMarker([lat,lng],{radius:7,fillColor:color,color:'#000',weight:1,opacity:0.9,fillOpacity:0.9}).addTo(map).bindPopup(`<strong>Event:</strong> ${r.event}`);
  }).subscribe();

  // Form submission
  document.getElementById('report-form').addEventListener('submit',async e=>{
    e.preventDefault();
    const eventName=document.getElementById('event').value.trim();
    const lat=parseFloat(document.getElementById('lat').value);
    const lng=parseFloat(document.getElementById('lng').value);
    if(!eventName || isNaN(lat) || isNaN(lng)){ showToast('Fill out all fields correctly.'); return; }
    await supabase.from('Aurora_reportss').insert([{ event:eventName, lat:lat, lng:lng, timestamp:Date.now() }]);
    showToast('Report submitted!');
    document.getElementById('event').value='';
  });
</script>

</body>
</html>
